<div th:replace="~{fragments/base :: layout}">
    <div th:fragment="content">
        <main class="p-3">
            <h2 class="mb-4">Danh sách phản ánh</h2>

            <!-- Form tìm kiếm -->
            <form method="get" action="/manage-feedback" class="row g-3 align-items-center mb-4">
                <div class="col-auto">
                    <input type="text" id="kw" name="kw" class="form-control" placeholder="Tìm theo nội dung"
                           th:value="${params['kw']}">
                </div>

                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                </div>
            </form>

            <!-- Bảng phản ánh -->
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle text-center">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th><i class="bi bi-person"></i> Người gửi</th>
                        <th><i class="bi bi-chat-left-dots"></i> Nội dung</th>
                        <th><i class="bi bi-calendar-event"></i> Ngày tạo</th>
                        <th><i class="bi bi-info-circle"></i> Trạng thái</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${feedbackList}">
                        <td th:text="${f.id}"></td>
                        <td th:text="${f.userId.fullName}"></td>
                        <td th:text="${f.content}"></td>
                        <td>
                            <span th:text="${#dates.format(f.createdAt, 'dd/MM/yyyy')}"></span>
                        </td>
                        <td>
                            <form th:action="@{/change-status}" method="post"
                                  class="change-status-form d-flex justify-content-center align-items-center gap-2"
                                  th:attr="data-id=${f.id}">
                                <input type="hidden" name="id" th:value="${f.id}" />

                                <select name="status" class="form-select form-select-sm" style="width: auto;">
                                    <option value="PENDING" th:selected="${f.status == T(linh.sunhouse_apartment.entity.Feedback.FeedbackStatus).PENDING}">PENDING</option>
                                    <option value="RESOLVED" th:selected="${f.status == T(linh.sunhouse_apartment.entity.Feedback.FeedbackStatus).RESOLVED}">RESOLVED</option>
                                </select>

                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="bi bi-arrow-repeat"></i> Cập nhật
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${feedbackList.size() == 0}">
                        <td colspan="5" class="text-center text-muted">Không có phản ánh nào.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".change-status-form").forEach(form => {
            form.addEventListener("submit", async function (e) {
                e.preventDefault(); // ❌ Không reload

                const formData = new FormData(this);
                const id = formData.get("id");
                const status = formData.get("status");

                try {
                    const response = await fetch("/change-status", {
                        method: "POST",
                        body: formData
                    });

                    if (!response.ok) throw new Error("Lỗi server");

                    // ✅ Giao diện được cập nhật mà không reload
                    alert("Đã cập nhật trạng thái mới cho phản ánh #" + id);
                } catch (err) {
                    alert("Không thể cập nhật trạng thái!");
                }
            });
        });
    });
</script>

