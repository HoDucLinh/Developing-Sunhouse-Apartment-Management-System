<div th:replace="~{fragments/base :: layout}">
    <div th:fragment="content">
        <main class="p-3">
            <h2 class="mb-4">Danh sách phản ánh</h2>

            <!-- Form tìm kiếm -->
            <form method="get" action="/manage-feedback" class="row g-3 align-items-end mb-4">
                <!-- Nội dung -->
                <div class="col-md-3">
                    <label for="kw" class="form-label">Nội dung</label>
                    <input type="text" id="kw" name="kw" class="form-control"
                           placeholder="Tìm theo nội dung"
                           th:value="${params['kw']}">
                </div>

                <!-- Người gửi -->
                <div class="col-md-3">
                    <label for="name" class="form-label">Người gửi</label>
                    <input type="text" id="name" name="name" class="form-control"
                           placeholder="Tên người gửi"
                           th:value="${params['name']}">
                </div>

                <!-- Trạng thái -->
                <div class="col-md-2">
                    <label for="status" class="form-label">Trạng thái</label>
                    <select id="status" name="status" class="form-select">
                        <option value="">-- Tất cả --</option>
                        <option value="PENDING" th:selected="${params['status'] == 'PENDING'}">PENDING</option>
                        <option value="RESOLVED" th:selected="${params['status'] == 'RESOLVED'}">RESOLVED</option>
                    </select>
                </div>

                <!-- Sắp xếp -->
                <div class="col-md-2">
                    <label for="sort" class="form-label">Sắp xếp</label>
                    <select id="sort" name="sort" class="form-select">
                        <option value="newest" th:selected="${params['sort'] == 'newest'}">Mới nhất</option>
                        <option value="oldest" th:selected="${params['sort'] == 'oldest'}">Cũ nhất</option>
                    </select>
                </div>

                <!-- Nút lọc -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Lọc
                    </button>
                </div>
            </form>


            <!-- Bảng phản ánh -->
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle text-center">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th><i class="bi bi-person"></i> Người gửi</th>
                        <th><i class="bi bi-person"></i> Người xử lý</th>
                        <th><i class="bi bi-chat-left-dots"></i> Nội dung</th>
                        <th><i class="bi bi-calendar-event"></i> Ngày tạo</th>
                        <th><i class="bi bi-info-circle"></i> Trạng thái</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="f : ${feedbackList}">
                        <td th:text="${f.id}"></td>
                        <td th:text="${f.userId.fullName}"></td>
                        <td th:text="${f.handlerId != null ? f.handlerId.fullName : '-'}"></td>
                        <td th:text="${f.content}"></td>
                        <td>
                            <span th:text="${#dates.format(f.createdAt, 'dd/MM/yyyy')}"></span>
                        </td>
                        <td>
                            <form th:action="@{/change-status}" method="post"
                                  class="change-status-form d-flex justify-content-center align-items-center gap-2"
                                  th:attr="data-id=${f.id}">
                                <input type="hidden" name="id" th:value="${f.id}" />

                                <select name="status" class="form-select form-select-sm w-auto fw-bold px-2 py-1"
                                        th:classappend="${f.status == T(linh.sunhouse_apartment.entity.Feedback.FeedbackStatus).PENDING} ? ' bg-warning text-dark' : ' bg-success text-white'">
                                    <option value="PENDING"
                                            th:selected="${f.status == T(linh.sunhouse_apartment.entity.Feedback.FeedbackStatus).PENDING}">
                                        PENDING
                                    </option>
                                    <option value="RESOLVED"
                                            th:selected="${f.status == T(linh.sunhouse_apartment.entity.Feedback.FeedbackStatus).RESOLVED}">
                                        RESOLVED
                                    </option>
                                </select>

                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="bi bi-arrow-repeat"></i> Cập nhật
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${feedbackList.size() == 0}">
                        <td colspan="5" class="text-center text-muted">Không có phản ánh nào.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".change-status-form").forEach(form => {
            form.addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const id = formData.get("id");
                const status = formData.get("status");

                try {
                    const response = await fetch("/change-status", {
                        method: "POST",
                        body: formData
                    });

                    if (!response.ok) throw new Error("Lỗi server");

                    location.reload();

                    // cập nhật trực tiếp UI
                    const select = this.querySelector("select");
                    select.value = status;
                    select.classList.remove("bg-warning", "text-dark", "bg-success", "text-white");
                    if (status === "PENDING") {
                        select.classList.add("bg-warning", "text-dark");
                    } else {
                        select.classList.add("bg-success", "text-white");
                    }

                    alert("Đã cập nhật trạng thái mới cho phản ánh #" + id);
                } catch (err) {
                    alert("Không thể cập nhật trạng thái!");
                }
            });
        });
    });
</script>

